{% extends "patient-portal/base.html" %}
{% load static %}

{% block dashboard %}active{% endblock dashboard %}

{% block title %}Patient Dashboard{% endblock title %}

{% block style %}
<link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<link rel="stylesheet" href="{% static "css/patient-portal/dashboard.css" %}">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock style %}

{% block content %}

<div class="dashboard-main-container">

    <!-- Header -->
    <div class="dashboard-page-header">
        <div>
            <h1 class="dashboard-welcome-title">Welcome, {{ request.user.first_name|default:"User" }} ðŸ‘‹</h1>
            <div class="dashboard-current-date" id="current-date"> {% now "l, d F Y" %} </div>
        </div>
    </div>

    <!-- Grid Layout -->
    <div class="dashboard-layout-grid">

        <!-- Upcoming Appointment -->
        <div class="dashboard-content-card dashboard-col-span-4">
            <div class="dashboard-card-header-title">
                <i class="far fa-calendar-check" style="color:var(--theme-gold-dark)"></i>
                Upcoming Appointment
            </div>

            {% if upcoming %}
                {% for appt in upcoming %}
                <div class="dashboard-appointment-widget">

                    <div class="dashboard-appointment-row">
                        <span class="dashboard-appointment-label">Therapy</span>
                        <span class="dashboard-appointment-value">{{ appt.therapy.name }}</span>
                    </div>

                    <div class="dashboard-appointment-row">
                        <span class="dashboard-appointment-label">Therapist</span>
                        <span class="dashboard-appointment-value">{{ appt.therapist.name }}</span>
                    </div>

                    <div class="dashboard-appointment-row" style="align-items:center; margin-top:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:1.4rem; font-weight:700; color:var(--theme-brown);">
                                {{ appt.date|date:"d" }}
                            </div>
                            <div style="font-size:0.75rem; color:var(--theme-muted);">
                                {{ appt.date|date:"M" }}
                            </div>
                        </div>

                        <div style="text-align:center;">
                            <div style="font-size:1.4rem; font-weight:700; color:var(--theme-brown);">
                                {{ appt.time }}
                            </div>
                            <div style="font-size:0.75rem; color:var(--theme-muted);">
                                {{ appt.time|slice:"-2:" }}
                            </div>
                        </div>

                        <button style="
                            background:var(--theme-brown);
                            color:white;
                            padding:8px 16px;
                            border:none;
                            border-radius:20px;
                            cursor:pointer;">
                            Details <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                </div>
                {% endfor %}
            {% else %}
                <p class="no-appt">No upcoming appointments.</p>
            {% endif %}
        </div>

        <!-- Progress Chart -->
        <div class="dashboard-content-card dashboard-col-span-8">
            <div class="dashboard-card-header-title">
                <i class="fas fa-chart-line" style="color:var(--theme-gold-dark)"></i>
                Recovery Overview
            </div>

            <div class="dashboard-chart-wrapper">
                <canvas id="progressChart"></canvas>
                <div id="chart-empty-state" class="progress-empty-state" style="display:none;">
                    No self-check entries yet.
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-content-card dashboard-col-span-6">
            <div class="dashboard-card-header-title">
                <i class="fas fa-bolt" style="color:var(--theme-gold-dark)"></i>
                Quick Actions
            </div>

            <div class="dashboard-action-grid">
                <a href="{% url 'patient-appointments' %}" class="dashboard-action-button">
                    <i class="far fa-calendar-plus"></i>
                    <span>Connect Doctor</span>
                </a>

                <a href="{% url 'patient-progress' %}" class="dashboard-action-button">
                    <i class="fas fa-tasks"></i>
                    <span>View Progress</span>
                </a>

                <a href="{% url 'billing:billing-home' %}" class="dashboard-action-button">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Pay Bills</span>
                </a>

                <a href="{% url 'patient-teleconsult' %}" class="dashboard-action-button">
                    <i class="fas fa-video"></i>
                    <span>Online Consultation</span>
                </a>
            </div>
        </div>

        <!-- âŒ Removed Recent Session Notes Card Completely -->

    </div>
</div>

<!-- Progress Chart Script -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    loadDashboardProgress();
});

async function loadDashboardProgress() {
    try {
        const res = await fetch("/progress/api/patient/progress/", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
            credentials: "include"
        });

        if (!res.ok) {
            showEmptyState();
            return;
        }

        const data = await res.json();
        renderSelfTrendDashboard(data.patient_daily);

    } catch (err) {
        console.error("Dashboard progress error:", err);
        showEmptyState();
    }
}

function renderSelfTrendDashboard(patientDaily) {
    const chartCanvas = document.getElementById("progressChart");
    const emptyState = document.getElementById("chart-empty-state");

    if (!patientDaily || !patientDaily.labels?.length) {
        chartCanvas.style.display = "none";
        emptyState.style.display = "block";
        return;
    }

    emptyState.style.display = "none";
    chartCanvas.style.display = "block";

    const ctx = chartCanvas.getContext("2d");

    if (window.dashboardChartInstance) {
        window.dashboardChartInstance.destroy();
    }

    window.dashboardChartInstance = new Chart(ctx, {
        type: "line",
        data: {
            labels: patientDaily.labels,
            datasets: [
                {
                    label: "Pain (Self)",
                    data: patientDaily.pain || [],
                    borderColor: "#78350f",
                    borderWidth: 2,
                    tension: 0.3,
                },
                {
                    label: "Stress (Self)",
                    data: patientDaily.stress || [],
                    borderColor: "#C8A300",
                    borderWidth: 2,
                    tension: 0.3,
                },
                {
                    label: "Sleep (Self)",
                    data: patientDaily.sleep || [],
                    borderColor: "#2E7D32",
                    borderWidth: 2,
                    tension: 0.3,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: "top" } },
            scales: { y: { beginAtZero: true, max: 10 } }
        }
    });
}

function showEmptyState() {
    document.getElementById("progressChart").style.display = "none";
    document.getElementById("chart-empty-state").style.display = "block";
}
</script>

{% endblock content %}
