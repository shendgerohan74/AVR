{% extends "patient-portal/base.html" %}
{% load static %}

{% block teleconsult %}active{% endblock teleconsult %}
{% block title %}Video Consultation{% endblock title %}

{% block style %}
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/patient-portal/teleconsult.css' %}">
{% endblock style %}

{% block content %}

<script>
    const CSRF = "{{ csrf_token }}";
    const THERAPIST_ID = "{{ therapist.id }}";   // Only once
</script>

<div class="video-main-container">

    <!-- VIDEO AREA -->
    <div class="video-stream-section">
        <div class="video-remote-feed" id="remoteVideo">
            <div class="video-status-text" id="callStatus">Waiting for doctor to join…</div>
        </div>

        <div class="video-controls-bar">
            <button class="video-control-btn" id="btnMute" onclick="toggleMute()"><i class="fas fa-microphone"></i></button>
            <button class="video-control-btn" id="btnCam" onclick="toggleVideo()"><i class="fas fa-video"></i></button>
            <button class="video-control-btn btn-start-call" onclick="startJitsiCall()">Join Live Consultation</button>
        </div>
    </div>

    <!-- CHAT SIDE -->
    <div class="video-sidebar">
        <div class="sidebar-info-header">
            <div class="patient-info-title">{{ therapist.name }}</div>
            <div class="patient-info-sub">{{ therapist.specialization }} • 15 mins</div>
        </div>

        <div id="chatContainer" class="sidebar-chat-area"></div>

        <div class="sidebar-input-area">
            <button class="chat-action-btn" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-paperclip"></i>
            </button>

            <input type="file" id="fileInput" style="display:none;">
            <input type="text" id="msgInput" class="chat-input-field" placeholder="Type a message…" onkeypress="handleEnter(event)">
            <button class="chat-action-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>

        <div class="sidebar-download-section">
            <button class="btn-download-presc"><i class="fas fa-file-prescription"></i> Download Prescription</button>
        </div>
    </div>

</div>

<!-- Jitsi API -->
<script src="https://meet.jit.si/external_api.js"></script>

<script>
let api = null;
let muted = false;
let videoOff = false;

function startJitsiCall() {
    const options = {
        roomName: "PanchkalpaTele_" + "{{ request.user.username }}",
        parentNode: document.querySelector("#remoteVideo"),
        width: "100%",
        height: "100%",
        userInfo: { displayName: "{{ request.user.first_name }}" }
    };

    api = new JitsiMeetExternalAPI("meet.jit.si", options);

    api.addEventListener("videoConferenceJoined", () => {
        document.getElementById("callStatus").style.display = "none";
    });
}

function toggleMute() {
    if (!api) return;
    muted = !muted;
    api.executeCommand("toggleAudio");
    document.getElementById("btnMute").style.background = muted ? "#d32f2f" : "rgba(255,255,255,0.2)";
}

function toggleVideo() {
    if (!api) return;
    videoOff = !videoOff;
    api.executeCommand("toggleVideo");
    document.getElementById("btnCam").style.background = videoOff ? "#d32f2f" : "rgba(255,255,255,0.2)";
}

function sendMessage() {
    const msg = document.getElementById("msgInput").value.trim();
    if (!msg) return;

    fetch("/chat/send/", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF },
        body: JSON.stringify({ message: msg, therapist_id: THERAPIST_ID })
    });

    document.getElementById("msgInput").value = "";
}

function loadMessages() {
    fetch(`/chat/get/${THERAPIST_ID}/`)
        .then(r => r.json())
        .then(data => {
            const box = document.getElementById("chatContainer");
            box.innerHTML = "";
            data.forEach(m => {
                box.innerHTML += `
                    <div class="chat-msg ${m.sender === 'patient' ? 'msg-sent' : 'msg-received'}">
                        ${m.message}
                        <span class="msg-time">${m.time}</span>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
}

setInterval(loadMessages, 1000);
function handleEnter(e) { if (e.key === "Enter") sendMessage(); }
</script>

{% endblock content %}
