{% extends "patient-portal/base.html" %}
{% load static %}

{% block progress %}active{% endblock progress %}
{% block title %}Therapy Progress{% endblock title %}

{% block style %}
<!-- Fonts (already in base, keep if needed) -->
<link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Page CSS -->
<link rel="stylesheet" href="{% static 'css/patient-portal/progress.css' %}">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock style %}

{% block content %}

<div class="progress-main-container">



    <!-- PAGE HEADER -->
    <div class="progress-page-header">
        <h1 class="progress-page-title">Your Recovery Progress</h1>
        <p class="progress-page-subtitle">
            Daily scores are recorded by you. Session metrics are recorded by your therapist.
        </p>
    </div>

    <div class="progress-grid-layout">

        <!-- 1. PATIENT SELF-REPORTED TREND CHART -->
        <div class="progress-content-card">
            <div class="progress-card-header">
                <i class="fas fa-chart-line" style="color:var(--theme-gold-dark)"></i>
                Symptom Trend (Self Reported)
            </div>

            <div class="progress-chart-wrapper">
                <canvas id="progressChart"></canvas>
                <div id="chart-empty-state" class="progress-empty-state" style="display:none;">
                    No self-check entries yet.
                </div>
            </div>
        </div>

        <div class="progress-content-card">
            <div class="progress-card-header">
                AI Progress Analysis
            </div>
            <div class="progress-report-container">
                <div class="ai-trend-chart">
                    <canvas id="aiTrendChart" height="140"></canvas>
                </div>
            </div>
        </div>

        <!-- 2. SELF-CHECK + THERAPIST METRICS -->
        <div class="progress-content-card">
            <div class="progress-card-header">
                <i class="fas fa-user-check" style="color:var(--theme-gold-dark)"></i>
                Today’s Self Check & Therapist Summary
            </div>

            <!-- Self Check Form -->
            <form class="progress-form" onsubmit="saveSelfCheck(); return false;">
                <label>Pain Level (0–10)</label>
                <input id="input-pain" type="number" min="0" max="10" class="progress-input">

                <label>Stress Level (0–10)</label>
                <input id="input-stress" type="number" min="0" max="10" class="progress-input">

                <label>Sleep Quality (0–10)</label>
                <input id="input-sleep" type="number" min="0" max="10" class="progress-input">

                <button class="progress-submit-btn">
                    <i class="fas fa-save"></i> Save Today’s Check-in
                </button>
            </form>

            <hr class="progress-divider">

            <!-- Therapist Session Summary -->
            <div class="progress-therapist-section">
                <h4 class="progress-section-title">Latest Therapist Session</h4>

                <p class="progress-meta">
                    Last updated: <span id="therapist-date">--</span>
                </p>

                <div class="progress-stats-grid">

                    <div class="progress-stat-box">
                        <h5>Mobility Score</h5>
                        <div class="progress-stat-value" id="val-mobility">--</div>
                    </div>

                    <div class="progress-stat-box">
                        <h5>Session Pain Score</h5>
                        <div class="progress-stat-value" id="val-session-pain">--</div>
                    </div>

                    <div class="progress-stat-box">
                        <h5>Therapist Remark</h5>
                        <div class="progress-stat-value small-text" id="val-remark">
                            No session recorded yet.
                        </div>
                    </div>

                </div>
            </div>
        </div>


        <!-- 3. AI-GENERATED PROGRESS REPORT -->
        <div class="progress-content-card">
            <div class="progress-card-header">
                <i class="fas fa-file-medical-alt" style="color:var(--theme-gold-dark)"></i>
                AI Progress Report
            </div>

            <div class="progress-report-container">

                <div class="progress-report-info">
                    <h4>Combined Progress Summary</h4>
                    <p>
                        Last generated on <span id="report-date">--</span>.
                    </p>

                    <p id="report-summary" class="progress-report-summary">
                        Report will appear here once enough data is recorded.
                    </p>
                </div>
            </div>
            <div class="progress-report-container">
                <!-- AI-generated lists -->
                <div class="progress-stats-grid">
                    <div class="progress-stats-box">
                        <h4>Improvements</h4>
                        <ul id="report-improvements" class="progress-list"></ul>
                    </div>
                    <div class="progress-stats-box">
                        <h4>Worsening Symptoms</h4>
                        <ul id="report-worsening" class="progress-list"></ul>
                    </div>

                    <div class="progress-stats-box">
                        <h4>Detected Patterns</h4>
                        <ul id="report-patterns" class="progress-list"></ul>
                    </div>
                    
                    <div class="progress-stats-box">
                        <h4>Red Flags</h4>
                        <ul id="report-redflags" class="progress-list red-text"></ul>
                    </div>
                    
                    <div class="progress-stats-box">
                        <h4>Recommendations</h4>
                        <ul id="report-recommendations" class="progress-list"></ul>
                    </div>
                    
                    <div class="progress-stats-box">
                        <h4>Next Steps</h4>
                        <ul id="report-nextsteps" class="progress-list"></ul>
                    </div>
                </div>

                <!-- <button class="progress-download-btn" onclick="downloadReport()">
                    <i class="fas fa-download"></i> Download PDF
                </button> -->

            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        loadProgressData();
    });

    async function loadProgressData() {
        try {
            const res = await fetch('/progress/api/patient/progress/', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            if (!res.ok) {
                showEmptyStates();
                return;
            }

            const data = await res.json();
            renderSelfTrend(data.patient_daily);
            renderTherapistSection(data.therapist_session);
            renderReport(data.report);

        } catch (err) {
            console.error(err);
            showEmptyStates();
        }
    }

    function renderSelfTrend(patientDaily) {
        const chartContainer = document.getElementById('progressChart');
        const emptyState = document.getElementById('chart-empty-state');

        if (!patientDaily || !patientDaily.labels || patientDaily.labels.length === 0) {
            chartContainer.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        chartContainer.style.display = 'block';

        const ctx = chartContainer.getContext('2d');

        if (window.progressChartInstance) {
            window.progressChartInstance.destroy();
        }

        window.progressChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: patientDaily.labels,
                datasets: [
                    {
                        label: 'Pain (Self)',
                        data: patientDaily.pain || [],
                        borderColor: '#78350f',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 3,
                    },
                    {
                        label: 'Stress (Self)',
                        data: patientDaily.stress || [],
                        borderColor: '#C8A300',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 3,
                    },
                    {
                        label: 'Sleep (Self)',
                        data: patientDaily.sleep || [],
                        borderColor: '#2E7D32',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 3,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        title: { display: true, text: 'Score (0–10)' }
                    }
                }
            }
        });
    }

    async function saveSelfCheck() {
        const payload = {
            pain: Number(document.getElementById("input-pain").value),
            stress: Number(document.getElementById("input-stress").value),
            sleep: Number(document.getElementById("input-sleep").value)
        };

        const res = await fetch("/progress/api/patient/progress/save/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            credentials: "include",
            body: JSON.stringify(payload),
            
            
        });
        
        console.log(payload);

        if (res.ok) {
            alert("Saved!");
            loadProgressData();
        } else {
            alert("Error saving");
        }
    }

    function renderTherapistSection(session) {
        document.getElementById('therapist-date').textContent =
            (session && session.date) || '--';

        document.getElementById('val-mobility').textContent =
            (session && session.mobility_score != null) ? session.mobility_score : '--';

        document.getElementById('val-session-pain').textContent =
            (session && session.pain_score != null) ? session.pain_score : '--';

        document.getElementById('val-remark').textContent =
            (session && session.remark) ? session.remark : 'No therapist notes yet.';
    }

    function renderReport(report) {
        // Basic Summary + Date (keep existing behavior)
        document.getElementById('report-date').textContent =
            (report && report.last_updated) || '--';

        document.getElementById('report-summary').textContent =
            (report && report.summary) || 'Report will appear here once enough data is recorded.';

        // New AI fields (safe even if empty)
        if (typeof renderList === "function") {
            renderList('report-improvements', report?.improvements);
            renderList('report-worsening', report?.worsening);
            renderList('report-patterns', report?.patterns);
            renderList('report-redflags', report?.red_flags);
            renderList('report-recommendations', report?.recommendations);
            renderList('report-nextsteps', report?.next_steps);
        }

        // AI Trend Chart (only draw if available)
        if (typeof renderAITrendChart === "function" && report) {
            renderAITrendChart(report);
        }
    }


    function showEmptyStates() {
        document.getElementById('progressChart').style.display = 'none';
        document.getElementById('chart-empty-state').style.display = 'block';
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function downloadReport() {
        window.location.href = '/api/patient/progress/download/';
    }

    function renderAITrendChart(report) {
        const ctx = document.getElementById('aiTrendChart').getContext('2d');

        const score =
            (report.improvements?.length || 0) * 2 +
            (report.patterns?.length || 0) * 1 +
            (report.worsening?.length || 0) * -2 +
            (report.red_flags?.length || 0) * -3;

        const labels = [
            "Improvements",
            "Patterns",
            "Worsening",
            "Red Flags"
        ];

        const values = [
            (report.improvements?.length || 0),
            (report.patterns?.length || 0),
            -(report.worsening?.length || 0),
            -(report.red_flags?.length || 0)
        ];

        if (window.aiTrendInstance) {
            window.aiTrendInstance.destroy();
        }

        window.aiTrendInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'AI Analysis Factors',
                    data: values,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                    }
                }
            }
        });

    }

    function renderList(id, items) {
        const el = document.getElementById(id);
        if (!el) return;

        el.innerHTML = "";

        if (!items || items.length === 0) {
            el.innerHTML = "<li class='empty-item'>No data available</li>";
            return;
        }

        items.forEach(item => {
            el.innerHTML += `<li>${item}</li>`;
        });
    }


</script>


{% endblock content %}