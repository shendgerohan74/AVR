{% extends "patient-portal/base.html" %}

{% load static %}
{% block teleconsult %}active{% endblock teleconsult %}

{% block title %}Video Consultation{% endblock title %}

{% block style %}
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static "css/patient-portal/teleconsult.css" %}">
{% endblock style %}    

{% block content %}

    <!-- MAIN CONTAINER -->
    <div class="video-main-container">
        
        <!-- LEFT: VIDEO STREAM -->
        <div class="video-stream-section">
            
            <!-- Remote Video (Doctor) -->
            <div class="video-remote-feed" id="remoteVideo">
                <div class="video-status-text" id="callStatus">Waiting for Dr. Ananya Vaidya to join...</div>
                <!-- Mock Doctor Image (Hidden initially) -->
                <img src="https://img.freepik.com/free-photo/woman-doctor-wearing-lab-coat-with-stethoscope-isolated_1303-29791.jpg" 
                     id="doctorFeed" style="display:none;" alt="Doctor Feed">
            </div>

            <!-- Local Video (Patient PIP) -->
            <div class="video-local-pip">
                <img src="https://randomuser.me/api/portraits/men/32.jpg" id="localVideoPlaceholder" alt="Me">
                <video id="localVideo" autoplay muted playsinline></video>
            </div>

            <!-- Controls -->
            <div class="video-controls-bar">
                <button class="video-control-btn" id="btnMute" onclick="toggleMute()"><i class="fas fa-microphone"></i></button>
                <button class="video-control-btn" id="btnCam" onclick="toggleVideo()"><i class="fas fa-video"></i></button>
                
                <!-- Start/End Toggle -->
                <button class="video-control-btn btn-start-call" id="btnCallAction" onclick="toggleCall()">
                    Start Call
                </button>
            </div>
        </div>

        <!-- RIGHT: SIDEBAR (Chat) -->
        <div class="video-sidebar">
            
            <!-- Patient Info Header -->
            <div class="sidebar-info-header">
                <div class="patient-info-title">Dr. Ananya Vaidya</div>
                <div class="patient-info-sub">Ayurvedic Physician â€¢ 15 mins remaining</div>
            </div>

            <!-- Chat Messages -->
            <div class="sidebar-chat-area" id="chatContainer">
                <div class="chat-msg msg-received">
                    Namaste Aniket! I will be joining the call in a moment.
                    <span class="msg-time">10:00 AM</span>
                </div>
                <div class="chat-msg msg-received">
                    Please keep your latest reports ready.
                    <span class="msg-time">10:01 AM</span>
                </div>
            </div>

            <!-- Input Area -->
            <div class="sidebar-input-area">
                <button class="chat-action-btn" title="Upload Report" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="fileInput" style="display:none;" onchange="handleFileUpload(this)">
                
                <input type="text" class="chat-input-field" id="msgInput" placeholder="Type a message..." onkeypress="handleEnter(event)">
                
                <button class="chat-action-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- Download Prescription -->
            <div class="sidebar-download-section">
                <button class="btn-download-presc" onclick="downloadPrescription()">
                    <i class="fas fa-file-prescription"></i> Download Prescription
                </button>
            </div>

        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        let localStream = null;
        let isCallActive = false;

        // 1. CALL LOGIC (Start/End)
        async function toggleCall() {
            const btn = document.getElementById('btnCallAction');
            const doctorFeed = document.getElementById('doctorFeed');
            const statusText = document.getElementById('callStatus');
            const localVideo = document.getElementById('localVideo');
            const localPlaceholder = document.getElementById('localVideoPlaceholder');

            if (!isCallActive) {
                // --- START CALL ---
                try {
                    // Request Camera & Mic
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    
                    // Display Local Stream
                    localVideo.srcObject = localStream;
                    localVideo.style.display = 'block';
                    localPlaceholder.style.display = 'none';

                    // UI Updates
                    btn.innerHTML = '<i class="fas fa-phone-slash"></i>';
                    btn.classList.remove('btn-start-call');
                    btn.classList.add('btn-end-call', 'video-control-btn');
                    btn.style.width = '50px';
                    btn.style.padding = '0';

                    statusText.style.display = 'none';
                    doctorFeed.style.display = 'block'; // Simulate Doctor joining
                    
                    isCallActive = true;
                    addSystemMessage("You started the camera.");

                } catch (err) {
                    console.error("Error accessing media devices.", err);
                    alert("Could not access camera/microphone. Please allow permissions.");
                }

            } else {
                // --- END CALL ---
                if(confirm("End the consultation?")) {
                    // Stop Tracks
                    if (localStream) {
                        localStream.getTracks().forEach(track => track.stop());
                        localStream = null;
                    }

                    // UI Reset
                    localVideo.style.display = 'none';
                    localPlaceholder.style.display = 'block';
                    
                    btn.innerHTML = 'Start Call';
                    btn.classList.remove('btn-end-call', 'video-control-btn');
                    btn.classList.add('video-control-btn', 'btn-start-call');
                    btn.style.width = 'auto';
                    btn.style.padding = '0 25px';

                    statusText.style.display = 'block';
                    statusText.textContent = "Call Ended";
                    doctorFeed.style.display = 'none';
                    
                    // Reset Control Buttons Visuals
                    resetControls();

                    isCallActive = false;
                    addSystemMessage("Call ended.");
                }
            }
        }

        // 2. MEDIA CONTROLS
        function toggleMute() {
            if (!localStream) return;
            const audioTrack = localStream.getAudioTracks()[0];
            const btn = document.getElementById('btnMute');
            const icon = btn.querySelector('i');

            if (audioTrack.enabled) {
                audioTrack.enabled = false; // Mute
                icon.classList.replace('fa-microphone', 'fa-microphone-slash');
                btn.style.background = '#d32f2f';
            } else {
                audioTrack.enabled = true; // Unmute
                icon.classList.replace('fa-microphone-slash', 'fa-microphone');
                btn.style.background = 'rgba(255,255,255,0.2)';
            }
        }

        function toggleVideo() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            const btn = document.getElementById('btnCam');
            const icon = btn.querySelector('i');

            if (videoTrack.enabled) {
                videoTrack.enabled = false; // Turn Cam Off
                icon.classList.replace('fa-video', 'fa-video-slash');
                btn.style.background = '#d32f2f';
            } else {
                videoTrack.enabled = true; // Turn Cam On
                icon.classList.replace('fa-video-slash', 'fa-video');
                btn.style.background = 'rgba(255,255,255,0.2)';
            }
        }

        function resetControls() {
            const muteBtn = document.getElementById('btnMute');
            const vidBtn = document.getElementById('btnCam');
            
            muteBtn.style.background = 'rgba(255,255,255,0.2)';
            muteBtn.querySelector('i').className = 'fas fa-microphone';
            
            vidBtn.style.background = 'rgba(255,255,255,0.2)';
            vidBtn.querySelector('i').className = 'fas fa-video';
        }

        // 3. CHAT LOGIC
        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (text) {
                const container = document.getElementById('chatContainer');
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const html = `
                <div class="chat-msg msg-sent">
                    ${text}
                    <span class="msg-time">${time}</span>
                </div>`;
                
                container.innerHTML += html;
                input.value = '';
                container.scrollTop = container.scrollHeight; // Scroll to bottom
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function addSystemMessage(text) {
            const container = document.getElementById('chatContainer');
            const html = `<div style="text-align:center; font-size:0.75rem; color:#999; margin:10px 0;">${text}</div>`;
            container.innerHTML += html;
            container.scrollTop = container.scrollHeight;
        }

        // 4. UPLOAD LOGIC
        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const fileName = input.files[0].name;
                const container = document.getElementById('chatContainer');
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const html = `
                <div class="chat-msg msg-sent">
                    <i class="fas fa-file-pdf"></i> Sent file: <strong>${fileName}</strong>
                    <span class="msg-time">${time}</span>
                </div>`;
                
                container.innerHTML += html;
                container.scrollTop = container.scrollHeight;
                alert(`"${fileName}" uploaded successfully to doctor.`);
            }
        }

        function downloadPrescription() {
            alert("Downloading Prescription PDF...");
            // window.open('/api/download-prescription/123');
        }
    </script>

{% endblock content %}